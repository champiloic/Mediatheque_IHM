<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Détails du Livre</title>
    <link rel="stylesheet" href="detail.css">
</head>
<body>
    <img src="./logo.png" alt="Logo" class="logo">
    <div id="book-details">
        <p>Chargement des détails...</p>
    </div>
    <div id="add-to-list-container">
        <button id="addToListBtn">A lire</button>
        <select id="userLists" style="display: none;"></select>
    </div>
    <script>
        async function fetchBookDetails() {
            // Récupérer la clé du livre depuis l'URL
            const params = new URLSearchParams(window.location.search);
            const key = params.get('key');

            if (!key) {
                document.getElementById('book-details').innerHTML = '<p>Aucun livre sélectionné.</p>';
                return;
            }

            try {
                // Appeler l'API OpenLibrary pour récupérer les détails du livre
                const response = await fetch(`https://openlibrary.org${key}.json`);
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des détails du livre');
                }

                const book = await response.json();

                // Extraire les informations nécessaires
                const title = book.title || 'Titre inconnu';
                const description = book.description
                    ? (typeof book.description === 'string' ? book.description : book.description.value)
                    : 'Description non disponible';
                const authors = book.authors
                    ? await Promise.all(book.authors.map(async (author) => {
                        const authorResponse = await fetch(`https://openlibrary.org${author.author.key}.json`);
                        const authorData = await authorResponse.json();
                        return authorData.name;
                    }))
                    : ['Auteur inconnu'];

                // Afficher les informations dans la page
                document.getElementById('book-details').innerHTML = `
                    <h1>${title}</h1>
                    <p><strong>Auteur(s):</strong> ${authors.join(', ')}</p>
                    <p><strong>Description:</strong> ${description}</p>
                `;
            } catch (error) {
                document.getElementById('book-details').innerHTML = '<p>Erreur: ' + error.message + '</p>';
            }
        }

        async function fetchUserLists() {
            const username = localStorage.getItem('username');
            if (!username) {
                alert('Veuillez vous connecter pour accéder à vos listes.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`http://openlibrary.org/people/${username}/lists.json`);
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des listes');
                }
                const data = await response.json();
                const lists = data.entries;

                const select = document.getElementById('userLists');
                select.innerHTML = lists.map(list => `<option value="${list.url}">${list.name}</option>`).join('');
                select.style.display = 'inline-block';
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function addToList() {
            const select = document.getElementById('userLists');
            const listUrl = select.value;
            const params = new URLSearchParams(window.location.search);
            const bookKey = params.get('key');

            if (!listUrl || !bookKey) {
                alert('Veuillez sélectionner une liste et un livre valide.');
                return;
            }

            try {
                const response = await fetch(`http://openlibrary.org${listUrl}/seeds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ add: [{ key: bookKey }] })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de l\'ajout du livre à la liste');
                }

                alert('Livre ajouté à la liste avec succès !');
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        document.getElementById('addToListBtn').addEventListener('click', () => {
            const select = document.getElementById('userLists');
            if (select.style.display === 'none') {
                fetchUserLists();
            } else {
                addToList();
            }
        });

        // Appeler la fonction pour récupérer et afficher les détails
        fetchBookDetails();
    </script>
</body>
</html>